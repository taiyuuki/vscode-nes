import{t as a,s as M,l as g,n as m}from"./index-C1mDYnUx.js";class c{static TABLE;crc;constructor(){this.crc=4294967295,c.TABLE||(c.TABLE=c.makeTable())}static makeTable(){const t=new Uint32Array(256);for(let s=0;s<256;s++){let r=s;for(let i=0;i<8;i++)r=1&r?3988292384^r>>>1:r>>>1;t[s]=r}return t}update(t){const s=255&(this.crc^t);this.crc=c.TABLE[s]^this.crc>>>8}getValue(){return(4294967295^this.crc)>>>0}}function f(u,t){return typeof t=="function"||t===void 0?!1:!["loader","nes","cpu","cpuram","ppu","crc","region","prg","chrsize","prgsize","prgoff","chroff","mappertype","submapper","haschrram","hasprgram","savesram","nt0","nt1","nt2","nt3","soundchip"].includes(u)&&!u.startsWith("_")}function k(u,t,s){return u==="chr"?s.haschrram?Array.from(t):null:t instanceof Uint8Array||Array.isArray(t)?m(t):t}class l{loader;mappertype=0;submapper=0;prgsize=0;prgoff=0;chroff=0;chrsize=0;nes;cpu;cpuram;ppu;prg=[];chr=[];chr_map=[];prg_map=[];prgram=new Uint8Array(8192);scrolltype=a.H_MIRROR;haschrram=!1;hasprgram=!0;savesram=!1;cram;cramUsed;pput0=new Array(1024).fill(0);pput1=new Array(1024).fill(0);pput2=new Array(1024).fill(0);pput3=new Array(1024).fill(0);nt0=[];nt1=[];nt2=[];nt3=[];crc=0;region=M.NTSC;constructor(t){this.setLoader(t)}supportsSaves(){return this.savesram}getMapperType(){return this.mappertype}getPRGSize(){return this.prgsize}getCHRSize(){return this.chrsize}destroy(){this.cpu=void 0,this.cpuram=void 0,this.ppu=void 0}static crc32(t){const s=new c;for(const r of t)s.update(r);return s.getValue()}loadROM(){this.loader.parseHeader(),this.prgsize=this.loader.prgsize,this.mappertype=this.loader.mappertype,this.prgoff=this.loader.prgoff,this.chroff=this.loader.chroff,this.chrsize=this.loader.chrsize,this.scrolltype=this.loader.scrolltype,this.savesram=this.loader.savesram,this.prg=this.loader.load(this.prgsize,this.prgoff),this.region=this.loader.tvtype,this.submapper=this.loader.submapper,this.crc=l.crc32(this.prg),this.crc!==1092891794&&this.crc!==2563560325||(this.hasprgram=!1),this.chr=this.loader.load(this.chrsize,this.chroff),this.chrsize===0&&(this.haschrram=!0,this.chrsize=8192,this.chr=new Array(8192).fill(0)),this.prg_map=new Array(32);for(let t=0;t<32;++t)this.prg_map[t]=1024*t&this.prgsize-1;this.chr_map=new Array(8);for(let t=0;t<8;++t)this.chr_map[t]=1024*t&this.chrsize-1;this.pput0.fill(160),this.pput1.fill(176),this.pput2.fill(192),this.pput3.fill(208),this.setmirroring(this.scrolltype)}reset(){}cartWrite(t,s){t>=24576&&t<32768&&(this.prgram[8191&t]=s)}cartRead(t){return t>=32768?this.prg[this.prg_map[(32767&t)>>10]+(1023&t)]:t>=24576&&this.hasprgram?this.prgram[8191&t]:t>>8}ppuRead(t){if(t<8192){const s=this.chr_map[t>>10]+(1023&t);return this.cram&&s<this.cram.length?this.cram[s]:this.chr[s]}switch(3072&t){case 0:return this.nt0[1023&t];case 1024:return this.nt1[1023&t];case 2048:return this.nt2[1023&t];default:return t>=16128?((t&=31)>=16&&!(3&t)&&(t-=16),this.ppu?.pal[t]??0):this.nt3[1023&t]}}ppuWrite(t,s){if((t&=16383)<8192){const r=this.chr_map[t>>10]+(1023&t);if(this.cram&&r<this.cram.length)return void(this.cram[r]=s);this.haschrram&&(this.chr[r]=s)}else switch(3072&t){case 0:this.nt0[1023&t]=s;break;case 1024:this.nt1[1023&t]=s;break;case 2048:this.nt2[1023&t]=s;break;case 3072:t>=16128&&t<=16383?((t&=31)>=16&&!(3&t)&&(t-=16),this.ppu.pal[t]=63&s):this.nt3[1023&t]=s;break;default:console.error("where?")}}notifyscanline(t){}checkA12(t){}cpucycle(t){}getROMInfo(){return`ROM INFO:
Mapper Type:  ${this.mappertype}
PRG Size:     ${this.prgsize}
CHR Size:     ${this.chrsize}
Mirroring:    ${this.scrolltype}
Battery Save: ${this.savesram?"Yes":"No"}
CRC32:        ${this.crc.toString(16).toUpperCase()}
`}setmirroring(t){switch(t){case a.H_MIRROR:this.nt0=this.pput0,this.nt1=this.pput0,this.nt2=this.pput1,this.nt3=this.pput1;break;case a.V_MIRROR:this.nt0=this.pput0,this.nt1=this.pput1,this.nt2=this.pput0,this.nt3=this.pput1;break;case a.SS_MIRROR0:this.nt0=this.pput0,this.nt1=this.pput0,this.nt2=this.pput0,this.nt3=this.pput0;break;case a.SS_MIRROR1:this.nt0=this.pput1,this.nt1=this.pput1,this.nt2=this.pput1,this.nt3=this.pput1;break;case a.FOUR_SCREEN_MIRROR:default:this.nt0=this.pput0,this.nt1=this.pput1,this.nt2=this.pput2,this.nt3=this.pput3}}hasSRAM(){return this.savesram}getTVType(){return this.region}setPRGRAM(t){this.prgram=new Uint8Array(t)}getPRGRam(){return Array.from(this.prgram)}getCRC(){return this.crc}getCPURAM(){return this.cpuram}init(){}setPropertyValueAuto(t,s){const r=this,i=r[t],h=(function(n,e,p,o){if(n==="chr"){const R=p;return R.haschrram&&Array.isArray(e)&&e.length===R.chrsize?e:void 0}return e&&typeof e=="object"&&e._compressed?g(e):o instanceof Uint8Array&&Array.isArray(e)?new Uint8Array(e):Array.isArray(o)&&Array.isArray(e)?[...e]:e})(t,s,this,i);h!==void 0&&(i instanceof Uint8Array&&h instanceof Uint8Array?i.set(h):Array.isArray(i)&&Array.isArray(h)?i.splice(0,i.length,...h):r[t]=h)}getMapperState(){const t={type:this.mappertype};for(const s in this){if(!Object.prototype.hasOwnProperty.call(this,s))continue;const r=this[s];if(f(s,r)){const i=k(s,r,this);i!==null&&(t[s]=i)}}return t.actualMirrorConfig={nt0:this.nt0===this.pput0?0:this.nt0===this.pput1?1:this.nt0===this.pput2?2:this.nt0===this.pput3?3:-1,nt1:this.nt1===this.pput0?0:this.nt1===this.pput1?1:this.nt1===this.pput2?2:this.nt1===this.pput3?3:-1,nt2:this.nt2===this.pput0?0:this.nt2===this.pput1?1:this.nt2===this.pput2?2:this.nt2===this.pput3?3:-1,nt3:this.nt3===this.pput0?0:this.nt3===this.pput1?1:this.nt3===this.pput2?2:this.nt3===this.pput3?3:-1},t.haschrram=this.haschrram,t}setMapperState(t){if(!t)return;const s=t.state||t;for(const r in s)r!=="actualMirrorConfig"&&r!=="haschrram"&&r!=="type"&&r in this&&this.setPropertyValueAuto(r,s[r]);if(s.actualMirrorConfig){const r=s.actualMirrorConfig;this.nt0=this.getPputByIndex(r.nt0),this.nt1=this.getPputByIndex(r.nt1),this.nt2=this.getPputByIndex(r.nt2),this.nt3=this.getPputByIndex(r.nt3)}else s.scrolltype!==void 0&&this.setmirroring(s.scrolltype);this.postLoadState(s)}postLoadState(t){}getPputByIndex(t){switch(t){case 0:default:return this.pput0;case 1:return this.pput1;case 2:return this.pput2;case 3:return this.pput3}}setLoader(t){this.loader=t}setVROMBank(t,s,r=0,i){i===void 0&&(i=s.length-r),this.chr_map[t]=r}setPROM8KBank(t,s){const r=8*(t-4),i=8192*(s%(this.prgsize>>13));for(let h=0;h<8;h++)this.prg_map[r+h]=(i+1024*h)%this.prgsize}setPROM16KBank(t,s){const r=s%(this.prgsize>>14);this.setPROM8KBank(t,2*r),this.setPROM8KBank(t+1,2*r+1)}setPROM32KBank(t){const s=t%(this.prgsize>>15);this.setPROM8KBank(4,4*s),this.setPROM8KBank(5,4*s+1),this.setPROM8KBank(6,4*s+2),this.setPROM8KBank(7,4*s+3)}setPROM32KBank4(t,s,r,i){this.setPROM8KBank(4,t),this.setPROM8KBank(5,s),this.setPROM8KBank(6,r),this.setPROM8KBank(7,i)}setCRAM1KBank(t,s){s&=31,this.cram||(this.cram=new Array(32768).fill(0)),this.chr_map[t]=1024*s%this.cram.length,this.cramUsed||(this.cramUsed=new Array(16).fill(0)),this.cramUsed[s>>2]=255}setCRAM2KBank(t,s){this.setCRAM1KBank(t,2*s),this.setCRAM1KBank(t+1,2*s+1)}setCRAM4KBank(t,s){this.setCRAM1KBank(t,4*s),this.setCRAM1KBank(t+1,4*s+1),this.setCRAM1KBank(t+2,4*s+2),this.setCRAM1KBank(t+3,4*s+3)}setCRAM8KBank(t){for(let s=0;s<8;s++)this.setCRAM1KBank(s,8*t+s)}setVROM1KBank(t,s){if(this.chrsize>0){const r=s%(this.chrsize>>10);this.chr_map[t]=1024*r}}setVROM2KBank(t,s){this.setVROM1KBank(t,2*s),this.setVROM1KBank(t+1,2*s+1)}setVROM4KBank(t,s){this.setVROM1KBank(t,4*s),this.setVROM1KBank(t+1,4*s+1),this.setVROM1KBank(t+2,4*s+2),this.setVROM1KBank(t+3,4*s+3)}setVROM8KBank(t){for(let s=0;s<8;s++)this.setVROM1KBank(s,8*t+s)}setVROM8KBank8(t,s,r,i,h,n,e,p){this.setVROM1KBank(0,t),this.setVROM1KBank(1,s),this.setVROM1KBank(2,r),this.setVROM1KBank(3,i),this.setVROM1KBank(4,h),this.setVROM1KBank(5,n),this.setVROM1KBank(6,e),this.setVROM1KBank(7,p)}getPROM8KSize(){return this.prgsize>>13}getPROM16KSize(){return this.prgsize>>14}getPROM32KSize(){return this.prgsize>>15}getVROM1KSize(){return this.chrsize>>10}getVROM2KSize(){return this.chrsize>>11}getVROM4KSize(){return this.chrsize>>12}getVROM8KSize(){return this.chrsize>>13}setVRAMMirror(t){switch(t){case 0:default:this.setmirroring(a.H_MIRROR);break;case 1:this.setmirroring(a.V_MIRROR);break;case 2:this.setmirroring(a.FOUR_SCREEN_MIRROR);break;case 3:this.setmirroring(a.SS_MIRROR0);break;case 4:this.setmirroring(a.SS_MIRROR1)}}setVRAMMirrorCustom(t,s,r,i){const h=3&t,n=3&s,e=3&r,p=3&i;this.nt0=this.getPputByIndex(h),this.nt1=this.getPputByIndex(n),this.nt2=this.getPputByIndex(e),this.nt3=this.getPputByIndex(p)}SetVROM_Bank(t,s,r=0,i){this.setVROMBank(t,s,r,i)}SetVROM_1K_Bank(t,s){this.setVROM1KBank(t,s)}SetVROM_2K_Bank(t,s){this.setVROM2KBank(t,s)}SetVROM_4K_Bank(t,s){this.setVROM4KBank(t,s)}SetVROM_8K_Bank(t){this.setVROM8KBank(t)}SetVROM_8K_Bank8(t,s,r,i,h,n,e,p){this.setVROM8KBank8(t,s,r,i,h,n,e,p)}SetCRAM_1K_Bank(t,s){this.setCRAM1KBank(t,s)}SetCRAM_2K_Bank(t,s){this.setCRAM2KBank(t,s)}SetCRAM_4K_Bank(t,s){this.setCRAM4KBank(t,s)}SetCRAM_8K_Bank(t){this.setCRAM8KBank(t)}}export{l as n};

import{a as s}from"./index-C1mDYnUx.js";const r=[1,2,4,6],l=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30];class o{timers;volume=[0,0];lenCtrEnable=[!0,!0,!0,!0];pcmMode=!1;pcmIRQen=!1;cycles=0;pcmOut=0;lengthctr=[0,0,0,0];lenctrHalt=[!0,!0,!0,!0];envelopeValue=[15,15,15,15];envelopeCounter=[0,0,0,0];envelopePos=[0,0,0,0];envConstVolume=[!0,!0,!0,!0];envelopeStartFlag=[!1,!1,!1,!1];framectr=0;ctrmode=4;constructor(){this.timers=[new s(8,2),new s(8,2)]}clock(e){this.cycles+=e,this.cycles%7445!==this.cycles&&(this.clockframecounter(),this.cycles%=6445),this.timers[0].clock(e),this.timers[1].clock(e)}write(e,t){switch(e){case 0:this.lenctrHalt[0]=!!(32&t),this.timers[0].setduty(r[t>>6]),this.envConstVolume[0]=!!(16&t),this.envelopeValue[0]=15&t;break;case 1:case 5:break;case 2:this.timers[0].setperiod((65024&this.timers[0].getperiod())+(t<<1));break;case 3:this.lenCtrEnable[0]&&(this.lengthctr[0]=l[t>>3]),this.timers[0].setperiod((511&this.timers[0].getperiod())+((7&t)<<9)),this.timers[0].reset(),this.envelopeStartFlag[0]=!0;break;case 4:this.lenctrHalt[1]=!!(32&t),this.timers[1].setduty(r[t>>6]),this.envConstVolume[1]=!!(16&t),this.envelopeValue[1]=15&t;break;case 6:this.timers[1].setperiod((65024&this.timers[1].getperiod())+(t<<1));break;case 7:this.lenCtrEnable[1]&&(this.lengthctr[1]=l[t>>3]),this.timers[1].setperiod((511&this.timers[1].getperiod())+((7&t)<<9)),this.timers[1].reset(),this.envelopeStartFlag[1]=!0;break;case 16:this.pcmMode=!!(1&t),this.pcmIRQen=!!(128&t);break;case 17:this.pcmMode||t!==0&&(this.pcmOut=t)}}getval(){let e=0;for(let t=0;t<2;++t)e+=this.volume[t]*this.timers[t].getval()*750;return e+=this.pcmOut<<5,e}status(){return(this.lengthctr[0]===0?0:1)+(this.lengthctr[1]===0?0:2)}setlength(){for(let e=0;e<4;++e)!this.lenctrHalt[e]&&this.lengthctr[e]>0&&(--this.lengthctr[e],this.lengthctr[e]===0&&this.setvolumes())}setenvelope(){for(let e=0;e<2;++e)this.envelopeStartFlag[e]?(this.envelopeStartFlag[e]=!1,this.envelopePos[e]=this.envelopeValue[e]+1,this.envelopeCounter[e]=15):--this.envelopePos[e],this.envelopePos[e]<=0&&(this.envelopePos[e]=this.envelopeValue[e]+1,this.envelopeCounter[e]>0?--this.envelopeCounter[e]:this.lenctrHalt[e]&&this.envelopeCounter[e]<=0&&(this.envelopeCounter[e]=15))}setvolumes(){this.volume[0]=this.lengthctr[0]<=0?0:this.envConstVolume[0]?this.envelopeValue[0]:this.envelopeCounter[0],this.volume[1]=this.lengthctr[1]<=0?0:this.envConstVolume[1]?this.envelopeValue[1]:this.envelopeCounter[1]}clockframecounter(){this.framectr<4&&this.setenvelope(),(this.ctrmode!==4||this.framectr!==1&&this.framectr!==3)&&(this.ctrmode!==5||this.framectr!==0&&this.framectr!==2)||this.setlength(),++this.framectr,this.framectr%=this.ctrmode,this.setvolumes()}}export{o as i};

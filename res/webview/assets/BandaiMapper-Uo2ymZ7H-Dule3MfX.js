import{t as s}from"./index-C1mDYnUx.js";import{n as a}from"./Mapper-DR43KiVi-C3VBMEhO.js";class u extends a{irqCounter=0;irqLatch=0;irqEnabled=!1;interrupted=!1;eepromData=new Uint8Array(256);eepromSDA=!1;eepromSCL=!1;eepromRead=!1;patch=0;loadROM(){super.loadROM();for(let t=0;t<16;++t)this.prg_map[t]=1024*t;for(let t=16;t<32;++t)this.prg_map[t]=this.prgsize-1024*(32-t);if(this.chrsize>0)for(let t=0;t<8;++t)this.chr_map[t]=1024*t%this.chrsize;else{this.haschrram=!0,this.chrsize=8192,this.chr=new Array(8192).fill(0);for(let t=0;t<8;++t)this.chr_map[t]=1024*t}this.nt0=this.pput0,this.nt1=this.pput1,this.nt2=this.pput2,this.nt3=this.pput3,this.setmirroring(this.scrolltype),this.eepromData.fill(255)}cartRead(t){if(t>=24576&&t<32768){if(this.submapper===5&&this.eepromRead)return(this.readEEPROM()?16:0)|t>>8;if(this.submapper===4)return t>>8}return t>=32768?this.prg[this.prg_map[(32767&t)>>10]+(1023&t)]:super.cartRead(t)}cartWrite(t,e){(this.submapper===0||this.submapper===4)&&t>=24576&&t<32768||(this.submapper===0||this.submapper===5)&&t>=32768?this.handleRegisterWrite(t,e):super.cartWrite(t,e)}handleRegisterWrite(t,e){const r=15&t;switch(r){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:this.setCHRBank(r,e);break;case 8:this.setPRGBank(15&e);break;case 9:this.setMirroring(3&e);break;case 10:this.acknowledgeIRQ(),this.irqEnabled=!!(1&e),this.submapper===5&&(this.irqCounter=this.irqLatch),this.irqEnabled&&this.irqCounter===0&&this.triggerIRQ();break;case 11:this.submapper===4?this.irqCounter=65280&this.irqCounter|e:this.irqLatch=65280&this.irqLatch|e;break;case 12:this.submapper===4?this.irqCounter=255&this.irqCounter|e<<8:this.irqLatch=255&this.irqLatch|e<<8;break;case 13:this.submapper===5&&(this.eepromRead=!!(128&e),this.eepromSDA=!!(64&e),this.eepromSCL=!!(32&e),this.handleEEPROM())}}setCHRBank(t,e){if(this.chrsize>0){const r=Math.floor(this.chrsize/1024),i=r>0?e%r:0;this.chr_map[t]=1024*i}else this.chr_map[t]=1024*(7&e)}setPRGBank(t){const e=Math.floor(this.prgsize/16384),r=16*Math.min(t,e-1)*1024;for(let i=0;i<16;++i)this.prg_map[i]=r+1024*i;for(let i=16;i<32;++i)this.prg_map[i]=this.prgsize-1024*(32-i)}setMirroring(t){switch(t){case 0:this.setmirroring(s.V_MIRROR);break;case 1:this.setmirroring(s.H_MIRROR);break;case 2:this.setmirroring(s.SS_MIRROR0);break;case 3:this.setmirroring(s.SS_MIRROR1)}}acknowledgeIRQ(){this.interrupted&&(--this.cpu.interrupt,this.interrupted=!1)}triggerIRQ(){this.interrupted||(++this.cpu.interrupt,this.interrupted=!0)}cpucycle(t){this.irqEnabled&&this.irqCounter>0&&(this.irqCounter-=t,this.irqCounter<=0&&(this.irqCounter=0,this.triggerIRQ()))}readEEPROM(){return!1}handleEEPROM(){}ppuRead(t){if(t<8192){const e=t>>10&7,r=1023&t,i=this.chr_map[e]+r;return i>=0&&i<this.chr.length?this.chr[i]:0}return super.ppuRead(t)}ppuWrite(t,e){if(t<8192){if(this.haschrram||this.chrsize===0){const r=t>>10&7,i=1023&t,h=this.chr_map[r]+i;h>=0&&h<this.chr.length&&(this.chr[h]=e)}}else super.ppuWrite(t,e)}}export{u as default};

import{t as e,r as i}from"./index-C1mDYnUx.js";import{n as c}from"./Mapper-DR43KiVi-C3VBMEhO.js";class o extends c{whichbank=0;prgconfig=!1;chrconfig=!1;irqctrreload=0;irqctr=0;irqenable=!1;irqreload=!1;bank6=0;chrreg=[0,0,0,0,0,0];interrupted=!1;lastA12=!1;a12timer=0;loadROM(){super.loadROM();for(let t=1;t<=32;++t)this.prg_map[32-t]=this.prgsize-1024*t;for(let t=0;t<8;++t)this.chr_map[t]=0;this.setbank6()}cartWrite(t,r){if(t<32768||t>65535)super.cartWrite(t,r);else switch(57345&t){case 32768:this.whichbank=7&r;const h=(r&i.BIT6)!==0;h!==this.prgconfig&&(this.prgconfig=h,this.setbank6());const s=(r&i.BIT7)!==0;s!==this.chrconfig&&(this.chrconfig=s,this.remapChrBanks());break;case 32769:this.executeCommand(this.whichbank,r);break;case 40960:this.scrolltype!==e.FOUR_SCREEN_MIRROR&&this.setmirroring((r&i.BIT0)===0?e.V_MIRROR:e.H_MIRROR);break;case 40961:break;case 49152:this.irqctr=r;break;case 49153:this.irqctrreload=r;break;case 57344:this.interrupted&&--this.cpu.interrupt,this.interrupted=!1,this.irqenable=!1;break;case 57345:this.irqenable=!0}}setupchr(){this.chrconfig?(this.setppubank(1,0,this.chrreg[2]),this.setppubank(1,1,this.chrreg[3]),this.setppubank(1,2,this.chrreg[4]),this.setppubank(1,3,this.chrreg[5]),this.setppubank(2,4,this.chrreg[0]>>1<<1),this.setppubank(2,6,this.chrreg[1]>>1<<1)):(this.setppubank(1,4,this.chrreg[2]),this.setppubank(1,5,this.chrreg[3]),this.setppubank(1,6,this.chrreg[4]),this.setppubank(1,7,this.chrreg[5]),this.setppubank(2,0,this.chrreg[0]>>1<<1),this.setppubank(2,2,this.chrreg[1]>>1<<1))}executeCommand(t,r){switch(t){case 0:this.chrconfig===!1?(this.load1kVromBank(254&r,0),this.load1kVromBank(1+(254&r),1024)):(this.load1kVromBank(254&r,4096),this.load1kVromBank(1+(254&r),5120)),this.chrreg[0]=r;break;case 1:this.chrconfig===!1?(this.load1kVromBank(254&r,2048),this.load1kVromBank(1+(254&r),3072)):(this.load1kVromBank(254&r,6144),this.load1kVromBank(1+(254&r),7168)),this.chrreg[1]=r;break;case 2:this.chrconfig===!1?this.load1kVromBank(r,4096):this.load1kVromBank(r,0),this.chrreg[2]=r;break;case 3:this.chrconfig===!1?this.load1kVromBank(r,5120):this.load1kVromBank(r,1024),this.chrreg[3]=r;break;case 4:this.chrconfig===!1?this.load1kVromBank(r,6144):this.load1kVromBank(r,2048),this.chrreg[4]=r;break;case 5:this.chrconfig===!1?this.load1kVromBank(r,7168):this.load1kVromBank(r,3072),this.chrreg[5]=r;break;case 6:this.bank6=r,this.setbank6();break;case 7:const h=r&this.prgsize/8192-1;for(let s=0;s<8;++s)this.prg_map[s+8]=1024*(s+8*h)%this.prgsize}}setbank6(){if(this.prgconfig)for(let t=0;t<8;++t)this.prg_map[t]=this.prgsize-16384+1024*t,this.prg_map[t+16]=1024*(t+8*this.bank6)%this.prgsize;else for(let t=0;t<8;++t)this.prg_map[t]=1024*(t+8*this.bank6)%this.prgsize,this.prg_map[t+16]=this.prgsize-16384+1024*t}ppuRead(t){return this.checkA12(t),super.ppuRead(t)}ppuWrite(t,r){this.checkA12(t),super.ppuWrite(t,r)}checkA12(t){const r=(t&i.BIT12)!==0;r&&!this.lastA12?this.a12timer<=0&&this.clockScanCounter():!r&&this.lastA12&&(this.a12timer=8),--this.a12timer,this.lastA12=r}clockScanCounter(){this.irqreload||this.irqctr===0?(this.irqctr=this.irqctrreload,this.irqreload=!1):--this.irqctr,this.irqctr===0&&this.irqenable&&!this.interrupted&&(++this.cpu.interrupt,this.interrupted=!0)}setppubank(t,r,h){for(let s=0;s<t;++s)this.chr_map[s+r]=1024*(h+s)%this.chrsize}load1kVromBank(t,r){if(this.chrsize===0)return;const h=Math.floor(t/4)%(this.chrsize/4096),s=t%4*1024,a=r>>10;this.chr_map[a]=(4096*h+s)%this.chrsize}remapChrBanks(){for(let t=0;t<6;t++)this.chrreg[t]!==0&&this.executeCommand(t,this.chrreg[t])}forceRemapAllChrBanks(){this.chrconfig?(this.setppubank(1,0,this.chrreg[2]),this.setppubank(1,1,this.chrreg[3]),this.setppubank(1,2,this.chrreg[4]),this.setppubank(1,3,this.chrreg[5]),this.setppubank(2,4,this.chrreg[0]>>1<<1),this.setppubank(2,6,this.chrreg[1]>>1<<1)):(this.setppubank(2,0,this.chrreg[0]>>1<<1),this.setppubank(2,2,this.chrreg[1]>>1<<1),this.setppubank(1,4,this.chrreg[2]),this.setppubank(1,5,this.chrreg[3]),this.setppubank(1,6,this.chrreg[4]),this.setppubank(1,7,this.chrreg[5]))}postLoadState(t){this.setbank6(),this.forceRemapAllChrBanks();for(let r=0;r<6;r++)this.chrreg[r]!==void 0&&this.executeCommand(r,this.chrreg[r]);this.interrupted&&this.cpu&&(this.interrupted=!1,this.irqenable&&this.irqctr===0&&(++this.cpu.interrupt,this.interrupted=!0))}}export{o as default};

import{r as h,t as s}from"./index-C1mDYnUx.js";import{n}from"./Mapper-DR43KiVi-C3VBMEhO.js";class c extends n{static registerselectbits=[[[1,2],[6,7]],[[2,3],[0,1]],[[3,2],[1,0]]];registers;prgbank0=0;prgbank1=0;chrbank=new Array(8).fill(0);prgmode=!1;irqmode=!1;irqenable=!1;irqack=!1;firedinterrupt=!1;irqreload=0;irqcounter=22;vrc2mirror=!1;prescaler=341;constructor(r){switch(super(r),r.mappertype){case 21:default:this.registers=c.registerselectbits[0];break;case 23:this.registers=c.registerselectbits[1];break;case 25:this.registers=c.registerselectbits[2]}}loadROM(){super.loadROM();for(let i=1;i<=32;++i)this.prg_map[32-i]=this.prgsize-1024*i;for(let i=0;i<8;++i)this.chr_map[i]=1024*i&this.chrsize-1;const r=this.crc;this.vrc2mirror=r===3079733068||r===764755005||r===1686212549||r===504541066||r===880867291}cartWrite(r,i){if(r<32768||r>65535)return void super.cartWrite(r,i);const t=!!(r&1<<this.registers[0][0])||!!(r&1<<this.registers[1][0]),e=!!(r&1<<this.registers[0][1])||!!(r&1<<this.registers[1][1]);switch(r>>12){case 8:this.prgbank0=31&i;break;case 9:if(e)this.prgmode=(i&h.BIT1)!==0;else if(this.vrc2mirror)switch(1&i){case 0:this.setmirroring(s.V_MIRROR);break;case 1:this.setmirroring(s.H_MIRROR)}else switch(3&i){case 0:this.setmirroring(s.V_MIRROR);break;case 1:this.setmirroring(s.H_MIRROR);break;case 2:this.setmirroring(s.SS_MIRROR0);break;case 3:this.setmirroring(s.SS_MIRROR1)}break;case 10:this.prgbank1=31&i;break;case 11:case 12:case 13:case 14:{i&=15;const p=(r-45056>>11)+(e?1:0);let a=this.chrbank[p];a=t?15&a|i<<4:240&a|i,this.chrbank[p]=a;break}case 15:e?t?(this.irqenable=this.irqack,this.firedinterrupt&&--this.cpu.interrupt,this.firedinterrupt=!1):(this.irqack=(i&h.BIT0)!==0,this.irqenable=(i&h.BIT1)!==0,this.irqmode=(i&h.BIT2)!==0,this.irqenable&&(this.irqcounter=this.irqreload,this.prescaler=341),this.firedinterrupt&&--this.cpu.interrupt,this.firedinterrupt=!1):this.irqreload=t?15&this.irqreload|(15&i)<<4:240&this.irqreload|15&i}r<61440&&this.setbanks()}setbanks(){if(this.prgmode){for(let r=1;r<=8;++r)this.prg_map[8-r]=this.prgsize-1024*r;for(let r=1;r<=8;++r)this.prg_map[32-r]=this.prgsize-1024*r;for(let r=0;r<8;++r)this.prg_map[r+8]=1024*(r+8*this.prgbank0)%this.prgsize;for(let r=0;r<8;++r)this.prg_map[r+16]=1024*(r+8*this.prgbank1)%this.prgsize}else{for(let r=1;r<=16;++r)this.prg_map[32-r]=this.prgsize-1024*r;for(let r=0;r<8;++r)this.prg_map[r]=1024*(r+8*this.prgbank0)%this.prgsize;for(let r=0;r<8;++r)this.prg_map[r+8]=1024*(r+8*this.prgbank1)%this.prgsize}for(let r=0;r<8;++r)this.setppubank(1,r,this.chrbank[r])}setppubank(r,i,t){for(let e=0;e<r;++e)this.chr_map[e+i]=1024*(t+e)%this.chrsize}cpucycle(){this.irqenable&&(this.irqmode?this.scanlinecount():(this.prescaler-=3,this.prescaler<=0&&(this.prescaler+=341,this.scanlinecount())))}scanlinecount(){this.irqenable&&(this.irqcounter===255?(this.irqcounter=this.irqreload,this.firedinterrupt||this.cpu&&++this.cpu.interrupt,this.firedinterrupt=!0):++this.irqcounter)}}export{c as default};

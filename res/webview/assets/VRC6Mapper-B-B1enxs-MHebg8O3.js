import{r as h,t as r}from"./index-C1mDYnUx.js";import{t as n}from"./VRC6SoundChip-DWEdLwU8-BfEksc7g.js";import{n as c}from"./Mapper-DR43KiVi-C3VBMEhO.js";class a extends c{static registerselectbits=[[0,1],[1,0]];registers;prgbank0=0;prgbank1=0;chrbank=new Array(8).fill(0);irqmode=!1;irqenable=!1;irqack=!1;firedinterrupt=!1;irqreload=0;irqcounter=22;prescaler=341;sndchip;hasInitSound=!1;constructor(s){super(s),this.sndchip=new n,s.mappertype===24?this.registers=a.registerselectbits[0]:this.registers=a.registerselectbits[1]}loadROM(){super.loadROM();for(let s=1;s<=32;++s)this.prg_map[32-s]=this.prgsize-1024*s;for(let s=0;s<8;++s)this.chr_map[s]=1024*s&this.chrsize-1}cartWrite(s,i){if(s<32768||s>65535)return void super.cartWrite(s,i);const t=!!(s&1<<this.registers[0]),e=!!(s&1<<this.registers[1]);switch(s>>12){case 8:this.prgbank0=i,this.setbanks();break;case 9:case 10:this.sndchip.write((61440&s)+(e?2:0)+(t?1:0),i);break;case 12:this.prgbank1=i,this.setbanks();break;case 11:if(t&&e)switch(i>>2&3){case 0:this.setmirroring(r.V_MIRROR);break;case 1:this.setmirroring(r.H_MIRROR);break;case 2:this.setmirroring(r.SS_MIRROR0);break;case 3:this.setmirroring(r.SS_MIRROR1)}else this.sndchip.write((61440&s)+(e?2:0)+(t?1:0),i);break;case 13:this.chrbank[(e?2:0)+(t?1:0)]=i,this.setbanks();break;case 14:this.chrbank[(e?2:0)+(t?1:0)+4]=i,this.setbanks();break;case 15:e?t||(this.irqenable=this.irqack,this.firedinterrupt&&this.cpu&&--this.cpu.interrupt,this.firedinterrupt=!1):t?(this.irqack=!!(i&h.BIT0),this.irqenable=!!(i&h.BIT1),this.irqmode=!!(i&h.BIT2),this.irqenable&&(this.irqcounter=this.irqreload,this.prescaler=341),this.firedinterrupt&&this.cpu&&--this.cpu.interrupt,this.firedinterrupt=!1):this.irqreload=i}}setbanks(){for(let s=1;s<=8;++s)this.prg_map[32-s]=this.prgsize-1024*s;for(let s=0;s<16;++s)this.prg_map[s]=1024*(s+16*this.prgbank0)%this.prgsize;for(let s=0;s<8;++s)this.prg_map[s+16]=1024*(s+8*this.prgbank1)%this.prgsize;for(let s=0;s<8;++s)this.setppubank(1,s,this.chrbank[s])}setppubank(s,i,t){for(let e=0;e<s;++e)this.chr_map[e+i]=1024*(t+e)%this.chrsize}cpucycle(){this.irqenable&&(this.irqmode?this.scanlinecount():(this.prescaler-=3,this.prescaler<=0&&(this.prescaler+=341,this.scanlinecount())))}scanlinecount(){this.hasInitSound||(this.cpuram?.apu?.addExpnSound(this.sndchip),this.hasInitSound=!0),this.irqenable&&(this.irqcounter===255?(this.irqcounter=this.irqreload,this.firedinterrupt||this.cpu&&++this.cpu.interrupt,this.firedinterrupt=!0):++this.irqcounter)}postLoadState(s){if(this.sndchip=new n,this.hasInitSound=!1,s.sndchip&&typeof s.sndchip=="object"&&s.sndchip.registers){const i=s.sndchip.registers;for(let t=36864;t<=45059;t++){const e=t-36864;i[e]!==void 0&&this.sndchip.write(t,i[e])}}}}export{a as default};

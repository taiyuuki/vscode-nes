import{r as a}from"./index-C1mDYnUx.js";var r;function T(e){return(e%=2*Math.PI)<Math.PI/2?e/Math.PI:e<3*Math.PI/2?1-e/Math.PI:e/Math.PI-2}(function(e){e[e.CUTOFF=0]="CUTOFF",e[e.ATTACK=1]="ATTACK",e[e.DECAY=2]="DECAY",e[e.RELEASE=3]="RELEASE"})(r||(r={}));const f=(function(){const e=new Array(256);for(let t=0;t<e.length;++t)e[t]=Math.round(-Math.log(Math.sin((t+.5)*Math.PI/256/2))/Math.log(2)*256);return e})(),_=(function(){const e=new Array(256);for(let t=0;t<e.length;++t)e[t]=Math.round(1024*(Math.pow(2,t/256)-1));return e})(),A=(function(){const t=new Array(Math.ceil(80620.4054054054));for(let h=0;h<t.length;++h)t[h]=Math.floor(128*T(2*Math.PI*3.7*h/298295.5)+128);return t})(),p=(function(){const t=new Array(Math.ceil(46608.671875));for(let h=0;h<t.length;++h)t[h]=10*T(2*Math.PI*6.4*h/298295.5);return t})(),v=[.5,1,2,3,4,5,6,7,8,9,10,10,12,12,15,15],q=[0,1536,2048,2368,2560,2752,2880,3008,3072,3200,3264,3328,3392,3456,3520,3584],w=[0,0,0,0,98,120,146,171,195,216,293,341,390,471,602,683,780,964,1168,1366,1560,1927,2315,2731,3075,3855,4682,5461,6242,8035,9364,10921,12480,15423,18727,21856,24960,30847,37413,43713,51130,61580,74991,87425,99841,123161,149319,173949,200870,241044,281218,312464,337461,401739,496266,562435,602609,766957,937392,1205218,8388607,8388607,8388607,8388607,8388607,8388607,8388607,8388607,8388607,8388607,8388607,8388607,8388607,8388607,8388607,8388607],l=[0,0,0,0,8,10,12,14,16,20,24,28,32,40,48,56,65,77,96,112,129,161,193,224,258,321,386,449,516,643,771,898,1032,1285,1542,1796,2064,2570,3084,3591,4211,5268,6167,7183,8255,10282,12407,14360,16510,20552,24668,28745,33020,41154,49336,57391,66169,82308,98673,114783,132859,132859,132859,132859,132859,132859,132859,132859,132859,132859,132859,132859,132859,132859,132859,132859],m=8388608;class O{modenv_state=Array(6).fill(r.CUTOFF);carenv_state=Array(6).fill(r.CUTOFF);vol=Array(6).fill(511);freq=Array(6).fill(0);octave=Array(6).fill(0);instrument=Array(6).fill(0);mod=Array(6).fill(0);oldmodout=Array(6).fill(0);out=Array(6).fill(0);key=Array(6).fill(!1);chSust=Array(6).fill(!1);fmctr=0;amctr=0;phase=Array(6).fill(0);usertone=Array(8).fill(0);modenv_vol=Array(6).fill(511);carenv_vol=Array(6).fill(511);instdata=[this.usertone,[3,33,5,6,232,129,66,39],[19,65,20,13,216,246,35,18],[17,17,8,8,250,178,32,18],[49,97,12,7,168,100,97,39],[50,33,30,6,225,118,1,40],[2,1,6,0,163,226,244,244],[33,97,29,7,130,129,17,7],[35,33,34,23,162,114,1,23],[53,17,37,0,64,115,114,1],[181,1,15,15,168,165,81,2],[23,193,36,7,248,248,34,18],[113,35,17,6,101,116,24,22],[1,2,211,5,201,149,3,2],[97,99,12,0,148,192,51,246],[33,114,13,0,193,213,86,6]];ch=0;lpaccum=0;lpaccum2=0;s=1;write(t,h){switch(t){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:this.usertone[7&t]=h;break;case 16:case 17:case 18:case 19:case 20:case 21:const i=t-16;this.freq[i]=3840&this.freq[i]|h;break;case 32:case 33:case 34:case 35:case 36:case 37:const s=t-32;this.octave[s]=h>>1&7,this.freq[s]=255&this.freq[s]|(1&h)<<8,(h&a.BIT4)===0||this.key[s]||(this.carenv_state[s]=r.CUTOFF,this.modenv_state[s]=r.CUTOFF),this.key[s]=(h&a.BIT4)!==0,this.chSust[s]=(h&a.BIT5)!==0;break;case 48:case 49:case 50:case 51:case 52:case 53:const c=t-48;this.vol[c]=15&h,this.instrument[c]=h>>4&15}}clock(t){for(let h=0;h<t;++h)this.ch=(this.ch+1)%36,this.ch<6&&this.operate()}operate(){this.fmctr=(this.fmctr+1)%p.length,this.amctr=(this.amctr+1)%A.length,this.phase[this.ch]+=1/512*(this.freq[this.ch]<<this.octave[this.ch]),this.phase[this.ch]%=1024;const t=this.instdata[this.instrument[this.ch]],h=this.setEnvelope(t,this.modenv_state,this.modenv_vol,this.ch,!1)<<2,i=this.setEnvelope(t,this.carenv_state,this.carenv_vol,this.ch,!0)<<2;let s=q[this.freq[this.ch]>>5]-512*(7-this.octave[this.ch]);s<0&&(s=0);let c=t[2]>>6;c=c===0?0:s>>3-c;let o=t[3]>>6;o=o===0?0:s>>3-o;const n=7&~t[3],u=(t[0]&a.BIT6)===0?0:p[this.fmctr]*(1<<this.octave[this.ch]),y=v[15&t[0]],E=(n===7?0:this.mod[this.ch]+this.oldmodout[this.ch]>>2+n)+(u+y*this.phase[this.ch]),d=32*(63&t[2]),I=(t[0]&a.BIT7)===0?0:A[this.amctr],M=(t[3]&a.BIT3)!==0;this.mod[this.ch]=this.operator(E,d+h+c+I,M)<<2,this.oldmodout[this.ch]=this.mod[this.ch];const C=(t[1]&a.BIT6)===0?0:p[this.fmctr]*(this.freq[this.ch]<<this.octave[this.ch])/512,k=v[15&t[1]],F=(this.mod[this.ch]+this.oldmodout[this.ch]>>1)+(C+k*this.phase[this.ch]),g=128*this.vol[this.ch],B=(t[1]&a.BIT7)===0?0:A[this.amctr],S=(t[3]&a.BIT4)!==0;this.out[this.ch]=this.operator(F,g+i+o+B,S)<<2,this.outputSample(this.ch)}operator(t,h,i){return this.exp(this.logsin(t,i)+h)}exp(t){return t>a.BIT13-1&&(t=a.BIT13-1),(_[255&-t]+1024>>-(-t>>8))*this.s}logsin(t,h){switch(t>>8&3){case 0:return this.s=1,f[255&t];case 1:return this.s=1,f[255-(255&t)];case 2:return this.s=h?0:-1,f[255&t];default:return this.s=h?0:-1,f[255-(255&t)]}}outputSample(t){let h=24*this.out[t];h+=this.lpaccum,this.lpaccum-=h>>2;let i=this.lpaccum;i+=this.lpaccum2,this.lpaccum2-=i>>2}getval(){return this.lpaccum2}setEnvelope(t,h,i,s,c){const o=(t[c?1:0]&a.BIT4)!==0?(this.octave[s]<<1)+(this.freq[s]>>8):this.octave[s]>>1;switch(h[s]){case r.ATTACK:i[s]>8?i[s]-=w[4*(t[c?5:4]>>4)+o]:h[s]=r.DECAY,this.key[s]||(h[s]=r.RELEASE);break;case r.DECAY:i[s]<524288*(t[c?7:6]>>4)?i[s]+=l[4*(15&t[c?5:4])+o]:h[s]=r.RELEASE,this.key[s]||(h[s]=r.RELEASE);break;case r.RELEASE:const n=(t[c?1:0]&a.BIT5)!==0,u=this.chSust[s];this.key[s]?n||(i[s]+=l[4*(15&t[c?7:6])+o]):i[s]+=n?u?l[20+o]:l[4*(15&t[c?7:6])+o]:u?l[20+o]:l[28+o];break;case r.CUTOFF:default:i[s]<m?i[s]+=16384:(i[s]=m,this.key[s]&&(h[s]=r.ATTACK,this.phase[s]=0))}return i[s]<0&&(i[s]=0),i[s]>m&&(i[s]=m),h[s]===r.ATTACK?8388608-Math.floor(8388608*Math.log(8388608-i[s])/Math.log(8388608))>>14:i[s]>>14}}export{O as f};

import{r as i}from"./index-C1mDYnUx.js";import{s as e}from"./Namco163SoundChip-DhH6yyfX-ts8qZpah.js";import{n as a}from"./Mapper-DR43KiVi-C3VBMEhO.js";class o extends a{soundAddr=0;autoincrement=!1;irqenable=!1;interrupted=!1;chrramenable0=!1;chrramenable1=!1;sound=new e;hasInitSound=!1;irqcounter=16383;chrbanks=new Array(8).fill(0);chr_ram=new Array(16384).fill(0);loadROM(){super.loadROM();for(let r=1;r<=32;++r)this.prg_map[32-r]=this.prgsize-1024*r;for(let r=0;r<8;++r)this.chr_map[r]=1024*r&this.chrsize-1}cartRead(r){if(r>=18432&&r<20480){!this.hasInitSound&&this.cpuram?.apu&&(this.cpuram.apu.addExpnSound(this.sound),this.hasInitSound=!0);const s=this.sound.read(this.soundAddr);return this.autoincrement&&(this.soundAddr=this.soundAddr+1&127),s}return r<22528?(this.irqack(),255&this.irqcounter):r<24576?(this.irqack(),this.irqcounter>>8&127|(this.irqenable?128:0)):r>=32768?this.prg[this.prg_map[(32767&r)>>10]+(1023&r)]:r>=24576&&this.hasprgram?this.prgram[8191&r]:r>>8}cartWrite(r,s){if(r<18432||r>=24576&&r<32768||r>65535)super.cartWrite(r,s);else if(r<=20479)!this.hasInitSound&&this.cpuram?.apu&&(this.cpuram.apu.addExpnSound(this.sound),this.hasInitSound=!0),this.sound.write(this.soundAddr,s),this.autoincrement&&(this.soundAddr=this.soundAddr+1&127);else if(r<=22527)this.irqcounter&=32512,this.irqcounter|=s,this.irqack();else if(r<=24575)this.irqcounter&=255,this.irqcounter|=(127&s)<<8,this.irqenable=(s&i.BIT7)!==0,this.irqack();else if(r<=49151){const t=r>>11&7;this.setppubank(1,t,s),this.chrbanks[t]=s}else if(r<=51199)this.nt0=s<224?this.chr.slice(1024*s,1024*(s+1)):(s&i.BIT0)===0?this.pput0:this.pput1;else if(r<=51455)this.nt1=s<224?this.chr.slice(1024*s,1024*(s+1)):(s&i.BIT0)===0?this.pput0:this.pput1;else if(r<=55295)this.nt2=s<224?this.chr.slice(1024*s,1024*(s+1)):(s&i.BIT0)===0?this.pput0:this.pput1;else if(r<=57343)this.nt3=s<224?this.chr.slice(1024*s,1024*(s+1)):(s&i.BIT0)===0?this.pput0:this.pput1;else if(r<=59391)for(let t=0;t<8;++t)this.prg_map[t]=1024*(t+8*(63&s))%this.prgsize;else if(r<=61439){for(let t=0;t<8;++t)this.prg_map[t+8]=1024*(t+8*(63&s))%this.prgsize;this.chrramenable0=!(s&i.BIT6),this.chrramenable1=!(s&i.BIT7)}else if(r<=63487)for(let t=0;t<8;++t)this.prg_map[t+16]=1024*(t+8*(63&s))%this.prgsize;else r<=65535&&(this.autoincrement=(s&i.BIT7)!==0,this.soundAddr=127&s)}irqack(){this.interrupted&&(--this.cpu.interrupt,this.interrupted=!1)}cpucycle(r){this.irqcounter+=r,this.irqcounter>32767&&(this.irqcounter=32767),this.irqcounter===32767&&this.irqenable&&!this.interrupted&&(++this.cpu.interrupt,this.interrupted=!0),this.sound.clock(r)}setppubank(r,s,t){for(let h=0;h<r;++h)this.chr_map[h+s]=1024*(t+h)&this.chrsize-1}ppuRead(r){return r<4096?this.chrramenable0&&this.chrbanks[r>>10]>224?this.chr_ram[this.chr_map[r>>10]+(1023&r)]:this.chr[this.chr_map[r>>10]+(1023&r)]:r<8192?this.chrramenable1&&this.chrbanks[r>>10]>224?this.chr_ram[this.chr_map[r>>10]-229376+(1023&r)]:this.chr[this.chr_map[r>>10]+(1023&r)]:super.ppuRead(r)}ppuWrite(r,s){(r&=16383)<4096?this.chrramenable0&&this.chrbanks[r>>10]>224?this.chr_ram[this.chr_map[r>>10]-229376+(1023&r)]=s:this.chr[this.chr_map[r>>10]+(1023&r)]=s:r<8192?this.chrramenable1&&this.chrbanks[r>>10]>224?this.chr_ram[this.chr_map[r>>10]-229376+(1023&r)]=s:this.chr[this.chr_map[r>>10]+(1023&r)]=s:super.ppuWrite(r,s)}postLoadState(r){if(this.sound=new e,this.hasInitSound=!1,r.sound&&typeof r.sound=="object"&&r.sound.registers)for(let s=0;s<128;s++)r.sound.registers[s]!==void 0&&this.sound.write(s,r.sound.registers[s])}}export{o as default};

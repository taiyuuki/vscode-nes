import{r as e,t as i}from"./index-C1mDYnUx.js";import{n as p}from"./Mapper-DR43KiVi-C3VBMEhO.js";class n extends p{whichbank=0;prgconfig=!1;chrconfig=!1;chrmode1k=!1;irqmode=!1;irqctrreload=0;irqctr=0;irqenable=!1;irqreload=!1;prgreg0=0;prgreg1=0;prgreg2=0;chrreg=new Array(8).fill(0);interrupted=!1;remainder=0;intnextcycle=!1;loadROM(){super.loadROM();for(let t=0;t<8;++t)this.prg_map[t]=1024*t,this.prg_map[t+8]=1024*t;for(let t=1;t<=32;++t)this.prg_map[32-t]=this.prgsize-1024*t;for(let t=0;t<8;++t)this.chr_map[t]=0;this.setprgregs()}cartWrite(t,r){if(t<32768||t>65535)super.cartWrite(t,r);else if((t&e.BIT0)===0)t>=32768&&t<=40959?(this.whichbank=15&r,this.chrmode1k=(r&e.BIT5)!==0,this.prgconfig=(r&e.BIT6)!==0,this.chrconfig=(r&e.BIT7)!==0,this.setupchr(),this.setprgregs()):t>=40960&&t<=49151?this.scrolltype!==i.FOUR_SCREEN_MIRROR&&this.setmirroring((r&e.BIT0)===0?i.V_MIRROR:i.H_MIRROR):t>=49152&&t<=57343?(this.irqctrreload=r,this.irqreload=!0):t>=57344&&t<=65535&&(this.interrupted&&--this.cpu.interrupt,this.interrupted=!1,this.irqenable=!1,this.irqctr=this.irqctrreload);else if(t>=32768&&t<=40959)switch(this.whichbank){case 0:case 1:case 2:case 3:case 4:case 5:this.chrreg[this.whichbank]=r,this.setupchr();break;case 6:this.prgreg0=r,this.setprgregs();break;case 7:this.prgreg1=r,this.setprgregs();break;case 8:case 9:this.chrreg[this.whichbank-2]=r;break;case 15:this.prgreg2=r,this.setprgregs()}else t>=40960&&t<=49151||(t>=49152&&t<=57343?(this.irqreload=!0,this.irqmode=(r&e.BIT0)!==0):t>=57344&&t<=65535&&(this.irqenable=!0))}setupchr(){this.chrconfig?this.chrmode1k?(this.setppubank(1,0,this.chrreg[2]),this.setppubank(1,1,this.chrreg[3]),this.setppubank(1,2,this.chrreg[4]),this.setppubank(1,3,this.chrreg[5]),this.setppubank(1,4,this.chrreg[0]),this.setppubank(1,5,this.chrreg[6]),this.setppubank(1,6,this.chrreg[1]),this.setppubank(1,7,this.chrreg[7])):(this.setppubank(1,0,this.chrreg[2]),this.setppubank(1,1,this.chrreg[3]),this.setppubank(1,2,this.chrreg[4]),this.setppubank(1,3,this.chrreg[5]),this.setppubank(2,4,this.chrreg[0]>>1<<1),this.setppubank(2,6,this.chrreg[1]>>1<<1)):this.chrmode1k?(this.setppubank(1,0,this.chrreg[0]),this.setppubank(1,1,this.chrreg[6]),this.setppubank(1,2,this.chrreg[1]),this.setppubank(1,3,this.chrreg[7]),this.setppubank(1,4,this.chrreg[2]),this.setppubank(1,5,this.chrreg[3]),this.setppubank(1,6,this.chrreg[4]),this.setppubank(1,7,this.chrreg[5])):(this.setppubank(1,4,this.chrreg[2]),this.setppubank(1,5,this.chrreg[3]),this.setppubank(1,6,this.chrreg[4]),this.setppubank(1,7,this.chrreg[5]),this.setppubank(2,0,this.chrreg[0]>>1<<1),this.setppubank(2,2,this.chrreg[1]>>1<<1))}setprgregs(){if(this.prgconfig)for(let t=0;t<8;++t)this.prg_map[t]=1024*(t+8*this.prgreg2)%this.prgsize,this.prg_map[t+8]=1024*(t+8*this.prgreg0)%this.prgsize,this.prg_map[t+16]=1024*(t+8*this.prgreg1)%this.prgsize;else for(let t=0;t<8;++t)this.prg_map[t]=1024*(t+8*this.prgreg0)%this.prgsize,this.prg_map[t+8]=1024*(t+8*this.prgreg1)%this.prgsize,this.prg_map[t+16]=1024*(t+8*this.prgreg2)%this.prgsize}notifyscanline(t){this.irqmode||t>239&&t!==261||this.ppu?.mmc3CounterClocking()&&this.clockscanlinecounter()}cpucycle(t){if(this.intnextcycle&&(this.intnextcycle=!1,this.interrupted||(++this.cpu.interrupt,this.interrupted=!0)),this.irqmode){this.remainder+=t;for(let r=0;r<this.remainder;++r)3&r||this.clockscanlinecounter();this.remainder%=4}}clockscanlinecounter(){this.irqreload?(this.irqreload=!1,this.irqctr=this.irqctrreload+1):this.irqctr===0?this.irqctr=this.irqctrreload:--this.irqctr===0&&this.irqenable&&(this.intnextcycle=!0)}setppubank(t,r,h){for(let s=0;s<t;++s)this.chr_map[s+r]=1024*(h+s)%this.chrsize}}export{n as default};

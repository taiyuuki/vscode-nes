import{i as h}from"./MMC5SoundChip-BiH_FNxI-Bo1r5xir.js";import{r}from"./index-C1mDYnUx.js";import{n as a}from"./Mapper-DR43KiVi-C3VBMEhO.js";class g extends a{exram=new Uint8Array(1024);exramMode=0;chrMode=0;prgMode=0;wramWrite1=0;wramWrite2=0;multiplier1=0;multiplier2=0;prgpage=0;chrOr=0;wrambank=0;scanctrEnable=!1;irqPend=!1;chrregsA=new Array(8).fill(0);chrregsB=new Array(4).fill(0);prgregs=new Uint8Array(4);chrmapB=new Array(4).fill(0);romHere=[!1,!1,!1];scanctrLine=0;irqCounter=20;fillnt=new Array(1024).fill(0);soundchip;inFrame=!1;prgram=new Uint8Array(65536);fetchcount=0;exlatch=0;lastfetch=0;prevfetch=0;prevprevfetch=0;spritemode=!1;postLoadState(s){if(this.setupPRG(),this.setupCHR(),s.soundchip&&(this.soundchip=new h,this.cpuram?.apu&&this.cpuram.apu.addExpnSound(this.soundchip),s.soundchip.registers))for(let t=0;t<16;t++)s.soundchip.registers[t]!==void 0&&this.soundchip.write(t,s.soundchip.registers[t]);s.lastNtSetup!==void 0&&this.setMirroring(s.lastNtSetup,this.exram)}getMapperState(){const s=super.getMapperState();return s.lastNtSetup=this.getCurrentNtSetup(),s}getCurrentNtSetup(){let s=0;return s|=this.getNtType(this.nt0),s|=this.getNtType(this.nt1)<<2,s|=this.getNtType(this.nt2)<<4,s|=this.getNtType(this.nt3)<<6,s}getNtType(s){return s===this.pput0?0:s===this.pput1?1:s===this.fillnt?3:2}loadROM(){super.loadROM(),this.prgregs[3]=this.prgsize/8192-1,this.prgregs[2]=this.prgsize/8192-1,this.prgregs[1]=this.prgsize/8192-1,this.prgregs[0]=this.prgsize/8192-1,this.prgMode=3,this.setupPRG();for(let s=0;s<8;++s)this.chr_map[s]=1024*s;this.prgram=new Uint8Array(65536)}cartWrite(s,t){if(s<23552)switch(s){case 20480:case 20481:case 20482:case 20483:case 20484:case 20485:case 20486:case 20487:case 20496:case 20497:case 20501:this.soundchip||(this.soundchip=new h,this.cpuram?.apu?.addExpnSound(this.soundchip)),this.soundchip.write(s-20480,t);break;case 20736:this.prgMode=3&t,this.setupPRG();break;case 20737:this.chrMode=3&t,this.setupCHR();break;case 20738:this.wramWrite1=t;break;case 20739:this.wramWrite2=t;break;case 20740:this.exramMode=3&t;break;case 20741:this.setMirroring(t,this.exram);break;case 20742:this.fillnt.fill(t,0,960);break;case 20743:this.fillnt.fill((3&t)+((3&t)<<2)+((3&t)<<4)+((3&t)<<6),960);break;case 20755:this.wrambank=7&t;break;case 20756:this.prgregs[0]=127&t,this.romHere[0]=!!(t&r.BIT7),this.setupPRG();break;case 20757:this.prgregs[1]=127&t,this.romHere[1]=!!(t&r.BIT7),this.setupPRG();break;case 20758:this.prgregs[2]=127&t,this.romHere[2]=!!(t&r.BIT7),this.setupPRG();break;case 20759:this.prgregs[3]=127&t,this.setupPRG();break;case 20768:case 20769:case 20770:case 20771:case 20772:case 20773:case 20774:case 20775:this.chrregsA[s-20768]=t|this.chrOr,this.setupCHR();break;case 20776:case 20777:case 20778:case 20779:this.chrregsB[s-20776]=t|this.chrOr,this.setupCHR();break;case 20784:this.chrOr=(3&t)<<8;break;case 20992:t&r.BIT7&&console.warn("Split screen mode not supported yet");break;case 20995:this.scanctrLine=t;break;case 20996:this.scanctrEnable=!!(t&r.BIT7);break;case 20997:this.multiplier1=t;break;case 20998:this.multiplier2=t}else if(s<24576)this.exram[s-23552]=t;else if(s<32768){const i=8192*this.wrambank+(s-24576);this.prgram[i]=t}else if(s<40960&&!this.romHere[0]&&this.prgMode===3)this.prgram[8192*(7&this.prgregs[0])+(s-32768)]=t;else if(s<49152&&!this.romHere[1]){const i=this.prgMode===3?40960:32768,e=(this.prgMode===3?7&this.prgregs[1]:(7&this.prgregs[1])>>1)*(this.prgMode===3?8192:16384)+(s-i);this.prgram[e]=t}else s<57344&&!this.romHere[2]&&(this.prgram[8192*(7&this.prgregs[2])+(s-49152)]=t)}cartRead(s){if((!this.ppu?.renderingOn()||this.ppu.scanline>241)&&(this.inFrame=!1),s>=32768)return this.prgMode===0||this.prgMode===1&&(s>=49152||this.romHere[1])||this.prgMode===2&&(s>=57344||s>=49152&&this.romHere[2]||this.romHere[1])||this.prgMode===3&&(s>=57344||s>=49152&&this.romHere[2]||s>=40960&&this.romHere[1]||this.romHere[0])?this.prg[this.prg_map[(32767&s)>>10]+(1023&s)]:65535;if(s>=24576){const t=8192*this.wrambank+(s-24576);return this.prgram[t]}if(s>=23552)return this.exram[s-23552];switch(s){case 20501:return this.soundchip?this.soundchip.status():s>>8;case 20996:const t=(this.irqPend?128:0)+(this.inFrame?64:0);return this.irqPend&&(this.irqPend=!1,--this.cpu.interrupt),t;case 20997:return this.multiplier1*this.multiplier2&255;case 20998:return this.multiplier1*this.multiplier2>>8&255;default:return s>>8}}setupPRG(){switch(this.prgMode){case 1:this.setcpubank(16,16,(127&this.prgregs[3])>>1),this.setcpubank(16,0,(127&this.prgregs[1])>>1);break;case 2:this.setcpubank(8,24,127&this.prgregs[3]),this.setcpubank(8,16,127&this.prgregs[2]),this.setcpubank(8,8,127&this.prgregs[1]|1),this.setcpubank(8,0,126&this.prgregs[1]);break;case 3:this.setcpubank(8,24,127&this.prgregs[3]),this.setcpubank(8,16,127&this.prgregs[2]),this.setcpubank(8,8,127&this.prgregs[1]),this.setcpubank(8,0,127&this.prgregs[0]);break;default:this.setcpubank(32,0,(127&this.prgregs[3])>>2)}}setupCHR(){switch(this.chrMode){case 1:this.setppubank(4,4,this.chrregsA[7]),this.setppubank(4,0,this.chrregsA[3]),this.setppubankB(4,0,this.chrregsB[3]);break;case 2:this.setppubank(2,6,this.chrregsA[7]),this.setppubank(2,4,this.chrregsA[5]),this.setppubank(2,2,this.chrregsA[3]),this.setppubank(2,0,this.chrregsA[1]),this.setppubankB(2,2,this.chrregsB[3]),this.setppubankB(2,0,this.chrregsB[1]);break;case 3:this.setppubank(1,7,this.chrregsA[7]),this.setppubank(1,6,this.chrregsA[6]),this.setppubank(1,5,this.chrregsA[5]),this.setppubank(1,4,this.chrregsA[4]),this.setppubank(1,3,this.chrregsA[3]),this.setppubank(1,2,this.chrregsA[2]),this.setppubank(1,1,this.chrregsA[1]),this.setppubank(1,0,this.chrregsA[0]),this.setppubankB(1,3,this.chrregsB[3]),this.setppubankB(1,2,this.chrregsB[2]),this.setppubankB(1,1,this.chrregsB[1]),this.setppubankB(1,0,this.chrregsB[0]);break;default:this.setppubank(8,0,this.chrregsA[7]),this.setppubankB(4,0,this.chrregsB[3])}}setppubank(s,t,i){for(let e=0;e<s;++e)this.chr_map[e+t]=1024*(i+e)%this.chrsize}setppubankB(s,t,i){for(let e=0;e<s;++e)this.chrmapB[e+t]=1024*(i+e)%this.chrsize}setcpubank(s,t,i){for(let e=0;e<s;++e)this.prg_map[e+t]=1024*(i*s+e)&this.prgsize-1}ppuRead(s){if(s<8192){if(++this.fetchcount===3&&(this.spritemode=!0),this.spritemode)return this.chr[this.chr_map[s>>10]+(1023&s)];if(this.exramMode===1){if(this.exlatch===2)return++this.exlatch,this.chr[(1024*this.chrOr|4096*(63&this.exram[this.lastfetch])|4095&s)%this.chr.length];if(this.exlatch===3)return this.exlatch=0,this.chr[(1024*this.chrOr|4096*(63&this.exram[this.lastfetch])|4095&s)%this.chr.length]}return this.chr[this.chrmapB[s>>10&3]+(1023&s)]}if(this.prevfetch===this.prevprevfetch&&this.prevprevfetch===s&&(this.incScanline(),this.exlatch=0),this.prevprevfetch=this.prevfetch,this.prevfetch=s,this.spritemode=!1,this.fetchcount=0,this.exramMode===1){if(this.exlatch===0)++this.exlatch,this.lastfetch=1023&s;else if(this.exlatch===1){++this.exlatch;const t=this.exram[this.lastfetch];return(192&t)>>6|(192&t)>>4|(192&t)>>2|192&t}}return super.ppuRead(s)}incScanline(){this.inFrame?(this.irqCounter++===this.scanctrLine&&(this.irqPend=!0),this.irqPend&&this.scanctrEnable&&++this.cpu.interrupt):(this.inFrame=!0,this.irqCounter=0,this.irqPend&&(this.irqPend=!1,--this.cpu.interrupt))}setMirroring(s,t){switch(3&s){case 0:default:this.nt0=this.pput0;break;case 1:this.nt0=this.pput1;break;case 2:this.nt0=Array.from(t);break;case 3:this.nt0=this.fillnt}switch(3&(s>>=2)){case 0:default:this.nt1=this.pput0;break;case 1:this.nt1=this.pput1;break;case 2:this.nt1=Array.from(t);break;case 3:this.nt1=this.fillnt}switch(3&(s>>=2)){case 0:default:this.nt2=this.pput0;break;case 1:this.nt2=this.pput1;break;case 2:this.nt2=Array.from(t);break;case 3:this.nt2=this.fillnt}switch(3&(s>>=2)){case 0:default:this.nt3=this.pput0;break;case 1:this.nt3=this.pput1;break;case 2:this.nt3=Array.from(t);break;case 3:this.nt3=this.fillnt}}}export{g as default};

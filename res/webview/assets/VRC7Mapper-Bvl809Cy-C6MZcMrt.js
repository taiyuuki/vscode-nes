import{f as a}from"./VRC7SoundChip-DFbeBRFC-Bjfj4A1d.js";import{r as e,t as h}from"./index-C1mDYnUx.js";import{n}from"./Mapper-DR43KiVi-C3VBMEhO.js";class l extends n{prgbank0=0;prgbank1=0;prgbank2=0;chrbank=[0,0,0,0,0,0,0,0];irqmode=!1;irqenable=!1;irqack=!1;firedinterrupt=!1;irqreload=0;irqcounter=22;regaddr=0;sndchip=new a;hasInitSound=!1;prescaler=341;loadROM(){super.loadROM();for(let i=1;i<=32;++i)this.prg_map[32-i]=(this.prgsize-1024*i)%this.prgsize;for(let i=0;i<8;++i)this.chr_map[i]=1024*i&this.chrsize-1}cartWrite(i,s){if(i<32768||i>65535)return void super.cartWrite(i,s);const r=(i&e.BIT4)!==0||(i&e.BIT3)!==0,t=(i&e.BIT5)!==0;switch(i>>12){case 8:r?this.prgbank1=s:this.prgbank0=s,this.setbanks();break;case 9:r||t?r&&t?(this.hasInitSound||(this.cpuram?.apu?.addExpnSound(this.sndchip),this.hasInitSound=!0),this.sndchip.write(this.regaddr,s)):this.regaddr=s:(this.prgbank2=s,this.setbanks());break;case 10:this.chrbank[r?1:0]=s,this.setbanks();break;case 11:this.chrbank[2+(r?1:0)]=s,this.setbanks();break;case 12:this.chrbank[4+(r?1:0)]=s,this.setbanks();break;case 13:this.chrbank[6+(r?1:0)]=s,this.setbanks();break;case 14:if(r)this.irqreload=s;else switch(3&s){case 0:this.setmirroring(h.V_MIRROR);break;case 1:this.setmirroring(h.H_MIRROR);break;case 2:this.setmirroring(h.SS_MIRROR0);break;case 3:this.setmirroring(h.SS_MIRROR1)}break;case 15:r?(this.irqenable=this.irqack,this.firedinterrupt&&--this.cpu.interrupt,this.firedinterrupt=!1):(this.irqack=(s&e.BIT0)!==0,this.irqenable=(s&e.BIT1)!==0,this.irqmode=(s&e.BIT2)!==0,this.irqenable&&(this.irqcounter=this.irqreload,this.prescaler=341),this.firedinterrupt&&--this.cpu.interrupt,this.firedinterrupt=!1)}}setbanks(){for(let i=1;i<=8;++i)this.prg_map[32-i]=this.prgsize-1024*i;for(let i=0;i<8;++i)this.prg_map[i]=1024*(i+8*this.prgbank0)%this.prgsize;for(let i=0;i<8;++i)this.prg_map[i+8]=1024*(i+8*this.prgbank1)%this.prgsize;for(let i=0;i<8;++i)this.prg_map[i+16]=1024*(i+8*this.prgbank2)%this.prgsize;for(let i=0;i<8;++i)this.setppubank(1,i,this.chrbank[i])}setppubank(i,s,r){for(let t=0;t<i;++t)this.chr_map[t+s]=1024*(r+t)%this.chrsize}cpucycle(){this.irqenable&&(this.irqmode?this.scanlinecount():(this.prescaler-=3,this.prescaler<=0&&(this.prescaler+=341,this.scanlinecount())))}scanlinecount(){this.irqenable&&(this.irqcounter===255?(this.irqcounter=this.irqreload,this.firedinterrupt||++this.cpu.interrupt,this.firedinterrupt=!0):++this.irqcounter)}postLoadState(i){if(this.sndchip=new a,this.hasInitSound=!1,i.sndchip&&typeof i.sndchip=="object"&&i.sndchip.registers){const s=i.sndchip.registers;for(let r=0;r<s.length;r++)s[r]!==void 0&&this.sndchip.write(r,s[r])}}}export{l as default};
